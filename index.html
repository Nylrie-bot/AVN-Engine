<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Angkringan Visual Novel</title>

<!-- Manifest PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4285f4">

<!-- Font Icon (Material Icons) -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
/* --- Basic Reset & Body --- */
* { box-sizing: border-box; margin:0; padding:0; }
body { font-family: system-ui,sans-serif; background:#fff; color:#202124; transition: background 0.3s,color 0.3s; overflow-x:hidden; }
body.dark { background:#121212; color:#eee; }

/* --- Splash --- */
#splash {
  position:fixed; inset:0; background:#4285f4; color:#fff; display:flex;
  align-items:center; justify-content:center; font-size:26px; font-weight:bold; z-index:999;
}

/* --- Header --- */
.header { padding:14px; text-align:center; font-weight:bold; font-size:20px; display:flex; justify-content:center; align-items:center; gap:10px; position:relative; }
.toggle-dark { cursor:pointer; font-size:18px; position:absolute; right:10px; top:14px; user-select:none; }

/* --- Search Bars --- */
#homeSearchBar, #searchBar { margin:20px auto; width:90%; max-width:500px; display:flex; gap:10px; position:relative; }
#homeSearchBar input, #searchBar input { flex:1; padding:12px 16px; border-radius:24px; border:1px solid #ccc; font-size:16px; transition: background 0.3s,color 0.3s; }
#homeSearchBar button, #searchBar button { padding:12px 16px; border:none; border-radius:24px; background:#4285f4; color:#fff; cursor:pointer; font-weight:bold; }
body.dark #homeSearchBar input, body.dark #searchBar input { background:#1f1f1f; color:#eee; border-color:#444; }

/* --- Suggestions --- */
.autocomplete-list { position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #ddd; z-index:998; max-height:180px; overflow-y:auto; border-radius:8px; }
body.dark .autocomplete-list { background:#1f1f1f; border-color:#333; color:#eee; }
.suggestion-item { padding:8px; cursor:pointer; border-bottom:1px solid #ddd; }
body.dark .suggestion-item { border-color:#333; }
.suggestion-item:hover { background:#4285f4; color:#fff; }

/* --- Containers & Grid --- */
.container { padding:15px; padding-bottom:80px; display:none; transition:opacity 0.3s; }
.container.show { display:block; opacity:1; }
.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:12px; }
.item { display:flex; flex-direction:column; gap:8px; background:#f1f3f4; padding:8px; border-radius:12px; cursor:pointer; transition: transform 0.3s, box-shadow 0.3s, opacity 0.3s; opacity:0; }
.item.show { opacity:1; }
body.dark .item { background:#1f1f1f; }
.item:hover { transform:translateY(-3px); box-shadow:0 6px 12px rgba(0,0,0,.2); }

/* --- Thumbnail & Text --- */
.thumb { width:100%; height:180px; border-radius:10px; background-size:cover; background-position:center; }
.item-title { font-weight:bold; font-size:14px; }
.preview { font-size:12px; opacity:.8; }
.genre { font-size:11px; opacity:.6; }
.empty { opacity:.6; text-align:center; margin-top:20px; }

/* --- Overlay & Sheet --- */
.overlay { position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; z-index:998; }
.overlay.show { display:block; }
.sheet { position:fixed; left:0; right:0; bottom:-100%; background:#fff; border-radius:20px 20px 0 0; padding:10px; transition:.3s; max-height:90%; overflow:auto; z-index:999; }
body.dark .sheet { background:#1f1f1f; color:#eee; }
.sheet.show { bottom:0; }
.sheet iframe { width:100%; height:70vh; border:none; border-radius:12px; }
.fav { font-size:20px; float:right; cursor:pointer; user-select:none; margin-left:10px; }

/* --- Floating Nav --- */
.floating-nav { position:fixed; right:15px; bottom:15px; display:flex; flex-direction:column; gap:10px; z-index:999; }
.floating-nav button { padding:12px; border:none; border-radius:50%; background:#4285f4; color:#fff; cursor:pointer; font-size:16px; box-shadow:0 2px 6px rgba(0,0,0,.2); }

/* --- Overlay Menu --- */
.overlay-menu { position:fixed; top:0; right:0; width:250px; height:100%; background:#fff; transform:translateX(100%); transition:transform 0.3s ease; z-index:1000; padding:20px; overflow-y:auto; }
body.dark .overlay-menu { background:#1f1f1f; color:#eee; }
.overlay-menu.show { transform:translateX(0); }
.overlay-menu button { display:block; margin:10px 0; padding:10px; width:100%; border:none; border-radius:8px; background:#4285f4; color:#fff; cursor:pointer; font-weight:bold; }

/* --- Toast --- */
.toast { position:fixed; bottom:80px; left:50%; transform:translateX(-50%); background:#ffcc33; color:#000; padding:12px 20px; border-radius:20px; box-shadow:0 2px 6px rgba(0,0,0,.2); opacity:0; transition:opacity 0.5s; z-index:1001; }
.toast.show { opacity:1; }
</style>
</head>
<body>

<div id="splash">Angkringan Visual Novel</div>

<div class="header">
  Angkringan Visual Novel
  <div class="toggle-dark" onclick="toggleDark()">üåô</div>
</div>

<div id="page-home" class="container show">
  <div id="homeSearchBar">
    <input id="homeInput" placeholder="Cari judul / genre / kata kunci..." oninput="showSuggestions(this,homeSuggestions)">
    <button onclick="doHomeSearch()">Search</button>
    <div id="homeSuggestions" class="autocomplete-list"></div>
  </div>
  <div id="homeResults" class="grid"></div>
  <div id="emptyHome" class="empty">Belum ada rekomendasi</div>
</div>

<div id="page-search" class="container">
  <div id="searchBar">
    <input id="q" placeholder="Cari judul, genre, kata kunci..." oninput="lastKey=this.value;searchOffset=0;displayedLinks.clear();results.innerHTML='';loadMoreResults();">
  </div>
  <select id="tagFilter" onchange="searchOffset=0;displayedLinks.clear();results.innerHTML='';loadMoreResults();"><option value="">Semua Genre</option></select>
  <div id="results" class="grid"></div>
  <div id="empty" class="empty">Tidak ada hasil</div>
</div>

<div class="overlay" onclick="closeSheet()"></div>

<div class="sheet" id="sheet">
  <h3 id="sheetTitle"></h3>
  <div id="sheetGenre" class="genre"></div>
  <p id="sheetSum"></p>
  <span class="fav" onclick="toggleFav()">‚ù§Ô∏è</span>
  <iframe id="sheetFrame"></iframe>
</div>

<div class="floating-nav">
  <button onclick="showTab('home')">üè†</button>
  <button onclick="showTab('search')">üîç</button>
  <button onclick="toggleOverlayMenu()">‚ò∞</button>
</div>

<div class="overlay-menu" id="overlayMenu">
  <button onclick="showTab('home')">Home üè†</button>
  <button onclick="showTab('search')">Search üîç</button>
  <button onclick="showTab('about')">About ‚ÑπÔ∏è</button>
  <button onclick="toggleOverlayMenu()">Close ‚úñÔ∏è</button>
</div>

<div class="toast" id="toast">VN Baru Tersedia!</div>

<script>
let posts=[], currentLink="", currentTitle="", currentSum="", currentCats=[];
let favs=JSON.parse(localStorage.getItem("favs")||"[]");
let lastKey="", searchOffset=0, searchLimit=20;
let displayedLinks = new Set();

// Splash
setTimeout(()=>document.getElementById("splash").remove(),1500);

// Dark mode
function toggleDark(){document.body.classList.toggle("dark");}

// Tabs
function showTab(t){
  document.getElementById("page-home").style.display=t==="home"?"block":"none";
  document.getElementById("page-search").style.display=t==="search"?"block":"none";
  closeOverlayMenu();
}

// Overlay menu
function toggleOverlayMenu(){document.getElementById("overlayMenu").classList.toggle("show");}

// Sheet
function openSheet(t,s,c,l){
  currentTitle=t;currentSum=s;currentCats=c;currentLink=l;
  sheetTitle.innerText=t; sheetSum.innerText=s; sheetGenre.innerText=c.join(", ");
  sheetFrame.src=l; updateFavIcon();
  sheet.classList.add("show"); document.querySelector(".overlay").classList.add("show");
}
function closeSheet(){
  sheet.classList.remove("show"); document.querySelector(".overlay").classList.remove("show");
}

// Handle Android back button to close sheet first
window.addEventListener('popstate', function(event) {
  if(sheet.classList.contains('show')){
    closeSheet();
    history.pushState(null,null,location.href);
  }
});
history.pushState(null,null,location.href);

function toggleFav(){
  if(favs.includes(currentLink)) favs=favs.filter(x=>x!==currentLink);
  else favs.push(currentLink);
  localStorage.setItem("favs",JSON.stringify(favs));
  updateFavIcon();
}
function updateFavIcon(){document.querySelector(".fav").innerText=favs.includes(currentLink)?"‚ù§Ô∏è":"ü§ç";}

// Fetch feed
function loadFeed(d){ posts=d.feed.entry||[]; renderHome(); }
function fetchFeed(){
  const script=document.createElement("script");
  script.src=`https://angkringanvisualnovel.blogspot.com/feeds/posts/default?alt=json&callback=loadFeed&_=${Date.now()}`;
  document.body.appendChild(script);
}
fetchFeed();

// Home render
function renderHome(){
  const container=homeResults; container.innerHTML="";
  posts.slice(0,10).forEach(p=>{
    const t=p.title.$t,s=p.summary?.$t||"",c=(p.category||[]).map(x=>x.term),l=p.link.find(l=>l.rel==="alternate").href;
    container.innerHTML += `<div class="item show" onclick='openSheet(${JSON.stringify(t)},${JSON.stringify(s)},${JSON.stringify(c)},"${l}")'>
      <div class="thumb" style="background-image:url('${getThumb(p)}')"></div>
      <div><div class="item-title">${t}</div><div class="preview">${s.slice(0,90)}...</div><div class="genre">${c.join(", ")}</div></div>
    </div>`;
  });
}
function getThumb(p){
  let thumb=p.media$thumbnail?.url;
  const match=p.content?.$t.match(/<img[^>]+src="([^"]+)"/);
  if(match) thumb=match[1];
  if(thumb && thumb.includes('s72-c')) thumb=thumb.replace('s72-c','s400-c');
  return thumb||"https://via.placeholder.com/400x250";
}
</script>

<script src="https://angkringanvisualnovel.blogspot.com/feeds/posts/default?alt=json&callback=loadFeed"></script>

</body>
</html>
